const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-VvGz4Bh5.js","assets/pdf-D-gusrb1.js","assets/index-D4X4993P.js","assets/index-CRTFCKaE.css"])))=>i.map(i=>d[i]);
import{j as t,u as Be,a as Le,r as n,R as v,b as Ee,g as Te,_,s as Ae,c as Ie,d as _e,e as Oe,Z as ze,C as $e,L as Ve,A as Ue,B as He,T as We,f as le,h as G,S as Ze,i as qe,k as Ke,l as ce,m as de,n as Ge,o as Je,p as Xe,q as Qe}from"./index-D4X4993P.js";const Ye=({message:x,isOpen:O})=>t.jsx("div",{className:`fixed right-6 top-6 z-50 pointer-events-none transition-all duration-300 ${O?"opacity-100 translate-y-0":"opacity-0 -translate-y-2"}`,children:t.jsx("div",{className:"bg-green-600 text-white px-4 py-2 rounded-full shadow-lg text-sm font-medium ring-1 ring-green-700",children:x})}),ue="/JamesEnglish1028-My-Ebook-Reader/assets/pdf.worker.min-qwK7q_zL.mjs",et=v.lazy(()=>_(()=>import("./index-VvGz4Bh5.js"),__vite__mapDeps([0,1,2,3])).then(x=>({default:x.Document}))),fe=v.lazy(()=>_(()=>import("./index-VvGz4Bh5.js"),__vite__mapDeps([0,1,2,3])).then(x=>({default:x.Page}))),ot=({bookId:x,onClose:O})=>{const J=Be(),me=Le(),N=x??(J.id?Number(J.id):null),he=O??(()=>me("/")),[o,ge]=n.useState(null),[w,X]=n.useState(null),[pe,Q]=n.useState(!0),[Y,C]=n.useState(null),[h,xe]=n.useState(null),[l,p]=n.useState(1),[D,b]=n.useState(100),[y,M]=n.useState("page"),[we,ee]=n.useState(!1),z=v.useRef(null),[be,$]=n.useState(!1),[ke,V]=n.useState([]),[te,ve]=n.useState({}),[ae,B]=n.useState(null),j=v.useRef(null),[Ne,L]=n.useState(!1),[ye,U]=n.useState(!1),[je,H]=n.useState(!1),se=Ee(),[tt,oe]=n.useState(!1),[k,E]=n.useState([]),[F,W]=n.useState([]),[Pe,at]=n.useState(Te),[Se,T]=n.useState(!1),[ne,Ce]=n.useState(null),P=v.useRef(null),R=n.useRef(null),re=n.useRef(null),ie=n.useRef(!1);n.useEffect(()=>{let e=!1;(async()=>{try{const s=await _(()=>import("./index-VvGz4Bh5.js"),__vite__mapDeps([0,1,2,3]));try{s.pdfjs.GlobalWorkerOptions.workerSrc=ue,e=!0}catch(r){console.warn("Could not set worker via static pdfWorkerUrl",r)}if(!e){const r=await _(()=>import("./pdf-D-gusrb1.js").then(i=>i.p),[]);r.GlobalWorkerOptions.workerSrc=ue,e=!0}}catch(s){console.warn("Could not configure pdfjs worker dynamically",s),T(!0)}})();let a=null;return(async()=>{Q(!0),C(null),X(null);try{console.debug("[PdfReaderView] fetching book id=",N);const s=await ce.getBook(N);if(!s)try{const g=(await ce.getAllBooks()).map(S=>S.id).filter(Boolean);throw new Error(`Could not find this book in your library (requested id: ${N}). Available book ids: ${g.join(", ")||"none"}`)}catch{throw new Error(`Could not find this book in your library (requested id: ${N}).`)}if(s.format!=="PDF")throw new Error("The selected book is not in PDF format.");ge(s);const r=new Blob([s.epubData],{type:"application/pdf"});a=URL.createObjectURL(r),console.debug("[PdfReaderView] created objectUrl",a,"blob size",r.size),Ce(r.size),X(a)}catch(s){console.error("[PdfReaderView] fetchBookData error",s),C(s instanceof Error?s.message:"An unknown error occurred.")}finally{Q(!1)}})(),()=>{a&&URL.revokeObjectURL(a)}},[N]);const De=e=>{xe(e.numPages||null),p(1),(async()=>{try{oe(!0);const a=await e.getOutline();if(!a||a.length===0){V([]);return}let c=0;const s=async(i,g=0)=>{if(!i)return null;const S=i.title||"Untitled";let f=null;try{let u=i.dest;if(typeof u=="string"&&(u=await e.getDestination(u)),Array.isArray(u)&&u.length>0)try{f=await e.getPageIndex(u[0])+1}catch{}}catch{}const d=[];if(i.items&&i.items.length>0)for(const u of i.items){const I=await s(u,g+1);I&&d.push(I)}return{id:`pdf-toc-${c++}`,label:S,href:f?`page:${f}`:"",subitems:d}},r=[];for(const i of a){const g=await s(i,0);g&&r.push(g)}V(r);try{const i=[],g=async f=>{for(const d of f){if(d.href)if(d.href.startsWith("page:")){const m=Number(d.href.split(":")[1]);!isNaN(m)&&m>=1&&i.push({page:m,label:d.label})}else try{const m=await e.getDestination(d.href);if(Array.isArray(m)&&m.length>0)try{const u=await e.getPageIndex(m[0]);i.push({page:u+1,label:d.label})}catch{}}catch{}d.subitems&&d.subitems.length>0&&await g(d.subitems)}};await g(r),i.sort((f,d)=>f.page-d.page);const S={};for(let f=0;f<i.length;f++){const d=i[f].page,m=f+1<i.length?i[f+1].page-1:e.numPages||d;for(let u=d;u<=m;u++)S[u]=i[f].label}ve(S)}catch(i){console.warn("Failed to build pdf chapter map",i)}}catch(a){console.warn("Failed to map PDF outline",a),V([])}finally{oe(!1)}})();try{const a=Xe(o?.id??N);if(a&&typeof a=="string"&&a.startsWith("page:")){const c=Number(a.split(":")[1]);!isNaN(c)&&c>=1&&p(c)}}catch{}try{if(o?.id&&!ie.current){const a=Qe(o.id);a&&typeof a.zoomPercent=="number"&&b(a.zoomPercent),a&&a.fitMode==="width"&&M("width"),ie.current=!0}}catch{}},A=()=>{h&&p(e=>Math.min(h,e+1))},Z=()=>{p(e=>Math.max(1,e-1))},q=e=>{if(e){if(e.startsWith("page:")){const a=Number(e.split(":")[1]);!isNaN(a)&&a>=1&&p(a)}else isNaN(Number(e))||p(Number(e));L(!1)}};v.useEffect(()=>{if(!o?.id)return;P.current&&clearTimeout(P.current);const e=o.id;return P.current=window.setTimeout(()=>{try{Ae(e,`page:${l}`)}catch(a){console.warn("Failed to save last PDF position",a)}},800),()=>{P.current&&(clearTimeout(P.current),P.current=null)}},[l,o]),n.useEffect(()=>{if(o?.id){try{Ie(o.id,{zoomPercent:D,fitMode:y})}catch(e){console.warn("Failed to persist pdf view state",e)}ee(!0),z.current&&clearTimeout(z.current),z.current=window.setTimeout(()=>ee(!1),1200)}},[D,y,o]);const K=n.useCallback(()=>{if(!R.current)return;const e=R.current.getBoundingClientRect().width;re.current=e},[]);n.useEffect(()=>{K();const e=new ResizeObserver(()=>K());return R.current&&e.observe(R.current),()=>e.disconnect()},[K]),v.useEffect(()=>{const e=a=>{const c=document.activeElement&&document.activeElement.tagName;if(!(c==="INPUT"||c==="TEXTAREA")){if(a.key==="ArrowLeft")Z();else if(a.key==="ArrowRight")A();else if(a.key===" ")a.preventDefault(),A();else if(a.key==="+"||a.key==="="&&a.shiftKey)b(s=>Math.min(400,Math.round(s*1.15)));else if(a.key==="-"||a.key==="_")b(s=>Math.max(20,Math.round(s/1.15)));else if(a.key.toLowerCase()==="f")M(s=>s==="page"?"width":"page");else if(a.key==="?")$(s=>!s);else if(a.key.toLowerCase()==="c")L(s=>!s);else if(a.key.toLowerCase()==="b"){if(!o?.id)return;const s={id:new Date().toISOString(),cfi:`page:${l}`,label:`Page ${l}`,chapter:void 0,description:void 0,createdAt:Date.now()},r=[...k,s];E(r);try{G(o.id,r)}catch(i){console.warn(i)}}}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Z,A,o,l,k]),n.useEffect(()=>{if(!(!o||!o.id))try{const e=_e(o.id),a=Oe(o.id);E(e||[]),W(a||[])}catch(e){console.warn("Failed to load bookmarks/citations for PDF",e)}},[o]);const Fe=async e=>{if(!o?.id)return;if(k.some(r=>r.cfi===`page:${l}`))try{if(!await se({message:"A bookmark already exists for this page. Add another?"}))return}catch{return}const c={id:new Date().toISOString(),cfi:`page:${l}`,label:`Page ${l}`,chapter:te[l]||void 0,description:e||void 0,createdAt:Date.now()},s=[...k,c];E(s);try{G(o.id,s)}catch(r){console.warn(r)}U(!1),B("Bookmark added"),j.current&&clearTimeout(j.current),j.current=window.setTimeout(()=>B(null),1400)},Re=async e=>{if(!o?.id)return;if(F.some(r=>r.pageNumber===l&&(r.note||"")===(e||"")))try{if(!await se({message:"An identical citation already exists for this page. Add another?"}))return}catch{return}const c={id:new Date().toISOString(),cfi:`page:${l}`,note:e||void 0,createdAt:Date.now(),pageNumber:l,chapter:te[l]||void 0},s=[...F,c];W(s);try{le(o.id,s)}catch(r){console.warn(r)}H(!1),B("Citation added"),j.current&&clearTimeout(j.current),j.current=window.setTimeout(()=>B(null),1400)},Me=()=>pe?t.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:t.jsx(de,{text:"Loading PDF..."})}):Y?t.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:t.jsxs("div",{className:"text-center bg-slate-800 p-8 rounded-lg shadow-lg max-w-lg mx-auto",children:[t.jsx("h3",{className:"text-xl font-bold text-red-300 mb-2",children:"Could Not Open PDF"}),t.jsx("p",{className:"text-slate-300",children:Y})]})}):w?t.jsxs("div",{className:"w-full h-full flex flex-col",children:[t.jsxs("div",{ref:R,className:"flex-grow relative overflow-auto bg-slate-900/10 p-4 md:p-8",children:[t.jsx(n.Suspense,{fallback:t.jsx("div",{className:"w-full h-full flex items-center justify-center",children:t.jsx(de,{text:"Loading viewer..."})}),children:t.jsxs("div",{className:"w-full max-w-[1100px] mx-auto",children:[t.jsxs("div",{className:"flex items-center justify-between text-sm text-slate-300 mb-2",children:[t.jsxs("div",{children:["Size: ",ne?`${(ne/1024).toFixed(1)} KB`:"unknown"]}),w&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("a",{href:w,target:"_blank",rel:"noreferrer",className:"underline",children:"Open raw PDF"}),t.jsx("a",{href:w,download:o?.title?`${o.title}.pdf`:"book.pdf",className:"underline",children:"Download"})]})]}),t.jsx(et,{file:w,onLoadSuccess:De,onLoadError:e=>{console.error("PDF load error",e),C("Failed to load PDF file (viewer). The file may be corrupted or unsupported."),T(!0)},children:(()=>{const e=re.current||900;if(y==="width"){const r=Math.max(200,Math.floor(e-32));return t.jsx(fe,{pageNumber:l,width:r,onLoadError:i=>{console.error("PDF page load error",i),C("Failed to render PDF page. Showing fallback."),T(!0)}})}const c=Math.max(200,Math.floor(D/100*900));return t.jsx(fe,{pageNumber:l,width:c,onLoadError:s=>{console.error("PDF page load error",s),C("Failed to render PDF page. Showing fallback."),T(!0)}})})()})]})}),Se?t.jsx("iframe",{src:w,title:o?.title||"PDF Viewer",className:"w-full h-full border-0","aria-hidden":"false"}):t.jsx("iframe",{src:w,title:o?.title||"PDF Viewer",className:"w-full h-full border-0 hidden","aria-hidden":"true"})]}),t.jsxs("footer",{className:"flex items-center gap-4 p-4 bg-slate-800 z-20 text-white flex-shrink-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:Z,className:"p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500","aria-label":"Previous page",disabled:l<=1,children:t.jsx(Ge,{className:"w-5 h-5"})}),t.jsx("button",{onClick:A,className:"p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500","aria-label":"Next page",disabled:h!==null&&l>=h,children:t.jsx(Je,{className:"w-5 h-5"})})]}),t.jsxs("div",{className:"flex-grow flex flex-col justify-center",children:[t.jsx("input",{type:"range",min:"1",max:h||1,value:l,onChange:e=>p(Number(e.target.value)),className:"w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer","aria-label":"PDF progress",disabled:!h}),t.jsx("div",{className:"text-center text-sm text-slate-300 mt-2","aria-live":"polite",children:h?t.jsxs("span",{children:["Page ",l," of ",h]}):t.jsx("span",{className:"text-slate-400",children:"Loading pages..."})})]}),t.jsxs("div",{className:"w-28 flex flex-col items-center text-sm",children:[t.jsx("label",{className:"text-slate-300 text-xs",children:"Go to"}),t.jsx("input",{type:"number",min:1,max:h||9999,value:l||"",onChange:e=>{const a=parseInt(e.target.value||"1",10);isNaN(a)||a<1||p(Math.min(h||a,Math.max(1,a)))},className:"w-full text-center rounded-md bg-slate-700 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-sky-500","aria-label":"Jump to page"})]})]})]}):null;return t.jsxs("div",{className:"fixed inset-0 bg-slate-900 flex flex-col select-none",children:[t.jsx(ze,{value:y==="page"?`${D}%`:`Fit: ${y}`,isOpen:we}),t.jsx(Ye,{message:ae||"",isOpen:!!ae}),t.jsxs("header",{className:"flex items-center justify-between p-2 bg-slate-800 shadow-md z-20 text-white flex-shrink-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:he,className:"p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500","aria-label":"Close Reader",children:t.jsx($e,{className:"w-6 h-6"})}),t.jsxs("button",{onClick:()=>L(!0),className:"p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500","aria-label":"Contents and Bookmarks",children:[t.jsx(Ve,{className:"w-6 h-6"}),(k.length>0||F.length>0)&&t.jsx("span",{className:"absolute top-1 right-1 block h-2 w-2 rounded-full bg-sky-400 ring-2 ring-slate-800"})]})]}),t.jsxs("div",{className:"text-center truncate px-2",children:[t.jsx("h2",{className:"text-lg font-bold",children:o?.title||"PDF Reader"}),t.jsx("p",{className:"text-sm text-slate-400",children:o?.author})]}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("div",{className:"hidden sm:flex items-center gap-1",children:[t.jsx("button",{onClick:()=>b(e=>Math.max(20,Math.round(e/1.15))),className:"p-2 rounded hover:bg-slate-700","aria-label":"Zoom out",children:"-"}),t.jsxs("div",{className:"text-sm text-slate-300 px-2",children:[D,"%"]}),t.jsx("button",{onClick:()=>b(e=>Math.min(400,Math.round(e*1.15))),className:"p-2 rounded hover:bg-slate-700","aria-label":"Zoom in",children:"+"}),t.jsx("button",{onClick:()=>M(e=>e==="page"?"width":"page"),className:"p-2 rounded hover:bg-slate-700","aria-label":"Toggle fit mode",children:y==="page"?"Fit Page":"Fit Width"}),t.jsx("button",{onClick:()=>H(!0),className:"p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500","aria-label":"Create citation for this page",children:t.jsx(Ue,{className:"w-6 h-6"})}),t.jsx("button",{onClick:()=>U(!0),className:"p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500","aria-label":"Add bookmark to this page",children:t.jsx(He,{className:"w-6 h-6"})}),t.jsx("button",{onClick:()=>$(e=>!e),className:"p-2 rounded hover:bg-slate-700","aria-label":"Keyboard help",children:"?"})]})})]}),t.jsx("main",{className:"flex-grow relative min-h-0 bg-slate-800/50",children:Me()}),t.jsx(We,{isOpen:Ne,onClose:()=>L(!1),toc:ke,onTocNavigate:q,bookmarks:k,onBookmarkNavigate:e=>{q(e)},onDeleteBookmark:e=>{const a=k.filter(c=>c.id!==e);E(a),o?.id&&G(o.id,a)},citations:F,onCitationNavigate:e=>{q(e)},onDeleteCitation:e=>{const a=F.filter(c=>c.id!==e);W(a),o?.id&&le(o.id,a)},settings:Pe,bookData:o}),t.jsx(Ze,{isOpen:be,onClose:()=>$(!1),onZoomIn:()=>b(e=>Math.min(400,Math.round(e*1.15))),onZoomOut:()=>b(e=>Math.max(20,Math.round(e/1.15))),onToggleFit:()=>M(e=>e==="page"?"width":"page"),activeReader:"pdf"}),t.jsx(qe,{isOpen:ye,onClose:()=>U(!1),onSave:Fe}),t.jsx(Ke,{isOpen:je,onClose:()=>H(!1),onSave:Re})]})};export{ot as default};
